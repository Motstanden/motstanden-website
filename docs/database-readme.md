# General

This project relies on two SQLite databases that exists independently:
1. `sheet_archive.db`
     - This database contains all data that is related to the sheet archive.
2. `motstanden.db`
     - This database contains all other data. 

# Folder Structure

## Migrations
### migrations/motstanden_db
 - Contains the entire schema history for both motstanden.db.
 - The current schema is generated by running all sql files in order.
 - The current schema is autogenerated and dumped into './motstanden_schemas.sql'

### migrations/sheet_archive_db
 - Same as *migrations/motstanden_db* **but with sheet_archive.db instead**. 
### Rules
 1. Every change in the database must be deployed through a migrations script.
 2. Once a migration script has been deployed, they should never change or be deleted.
 3. Always update the database version in new migrations scripts. Example for the file: 02_insert_sheet_archive_data.sql:
      ```
      INSERT INTO version(migration) VALUES 
      ('02_insert_sheet_archive_data.sql');
      ``` 

 ### Resources
  - Good practices: https://enterprisecraftsmanship.com/posts/database-versioning-best-practices/

## Development environment variable
Usage of the database differs between production and development environments. An environment file is therefore used to differ between these environments. To set this variable, a `.env` file can be created and sourced.
This can be done by copying the [.env.example](.env.example) to `.env` and sourcing this file.

In linux, this can be done like this:
```sh
cp .env.example .env
source .env
```

## Backup database
To back up the database, make sure the environment variable `IS_DEV_ENV` is set.
Run the backup script via the command `sh create_backup.sh` to create a backup.

The names of databases and backup directory is set in [create_backup.sh](./create_backup.sh) and can be changed according to needs. 
The database names and backup directories will be different for production and development environments, and this is decided by the `IS_DEV_ENV` variable.

The variables in [create_backup.sh](./create_backup.sh) that may need to be changed in the future is:
- `DB_NAMES`: Names of databases that will be backed up
- `BACKUP_PARENT_DIRECTORY`: Directory where backups will be stored.

The script creates a backup directory and a corresponding directory for each database there. Backup names will start with the date the backup was done and the name of the database.

### Backup service and timer
For backing up the database, a systemd timer and service is used. The service executes the `create_backup.sh` script, and the timer triggers the service routinely (for example every week).

To implement automatic backup of database on the production server, the files [backup_motstanden.service](./systemd-backup-files/backup_motstanden.service) and [backup_motstanden.timer](./systemd-backup-files/backup_motstanden.timer) must be moved to the folder `/etc/systemd/system`, these must be loaded and the timer must be enabled.
This for example be done via this script:
```sh
sudo mv ./systemd-backup-files/backup_motstanden.* /etc/systemd/system
sudo systemctl daemon-reload
sudo systemctl enable backup_motstanden.timer
sudo systemctl start backup_motstanden.timer
```

The `.service` and `.timer` files lies in `/etc/systemd/system/` directory. 
For interacting with systemd timers and services, see arch-linux's excellent wiki:
- [Timers](https://wiki.archlinux.org/title/Systemd/Timers)
- [Services](https://wiki.archlinux.org/title/Systemd)
