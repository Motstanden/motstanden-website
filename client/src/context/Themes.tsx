import React, { useState, createContext, useContext } from 'react';
import { ThemeProvider, createTheme, Theme } from '@mui/material/styles';

// This must be imported here to provide default styling for date pickers and components in mui lab. 
// See documentation: 
//  - https://mui.com/x/react-date-pickers/getting-started/
//  - https://mui.com/material-ui/about-the-lab/
import type {} from '@mui/x-date-pickers/themeAugmentation';
import type {} from '@mui/lab/themeAugmentation';


export enum ThemeName {
    Dark = "dark",
    Light = "light"
}

type AppThemeType = {
    theme: Theme,
    name: ThemeName
}

const darkTheme: AppThemeType = {
    name: ThemeName.Dark,
    theme: createTheme({
        palette: {
            mode: 'dark',
            primary: {
                main: "#196E45"
                // light: ""       // Autogenerated from main value   
                // dark: ""
                // contrastText: ""
            },
            secondary: {
                main: "#90CAF9"
                // main: "#90CAF9"
                // light: ""       // Autogenerated from main value   
                // dark: ""
                // contrastText: "
            },
            background: {
                default: "#0C0C0C",
                paper: "#161616"
            },
            text: {
                primary: "#FFF",
                secondary: "#EEE"
            },
            // ---------------------------------
            // Autogenerated colors:
            //      * Uncomment to override    
            //      * Default colors can be found here: https://mui.com/material-ui/customization/palette/   
            // ---------------------------------

            // primary: {          
            //     main: "",        
            //     light: "",            
            //     dark: "",
            //     contrastText: "",
            // },
            // error: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // warning: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // info: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // success: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // }
        }
    })
}

const lightTheme: AppThemeType = {
    name: ThemeName.Light,
    theme: createTheme({
        palette: {
            mode: 'light',
            primary: {
                main: "#196E45",
                //light: "",        // Autogenerated from main value   
                //dark: "",
                //contrastText: "",
            },
            secondary: {
                main: "#1976D2"
                //light: "",        // Autogenerated from main value   
                //dark: "",
                //contrastText: "",
            },
            background: {
                default: "#E5E5E5",
                paper: "white"
            },
            text: {
                primary: "#000",
                secondary: "#252525"
            },
            
            // ---------------------------------
            // Autogenerated colors:
            //      * Uncomment to override 
            //      * Default colors can be found here: https://mui.com/material-ui/customization/palette/   
            // ---------------------------------
            
            // primary: {           
            //     main: "",        
            //     light: "",            
            //     dark: "",
            //     contrastText: "",
            // },
            // error: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // warning: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // info: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // },
            // success: {
            //     main: "",
            //     light: "",
            //     dark: "",
            //     contrastText: "",
            // }
        },
    })
}

const OsPreferDarkMode = () :boolean => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

const objectToTheme = (name: string | ThemeName | null | undefined) : AppThemeType  => {
    switch(name?.trim().toLowerCase()){
        case ThemeName.Light: return lightTheme
        case ThemeName.Dark:  return darkTheme
        default: return OsPreferDarkMode() ? darkTheme : lightTheme
    }
}

const themeStorageKey = "AppTheme"

const getDefaultTheme = (): AppThemeType => {
    let storedData = localStorage.getItem(themeStorageKey)
    let theme = objectToTheme(storedData)
    return theme;
} 

const setDefaultTheme = (theme: AppThemeType ) => localStorage.setItem(themeStorageKey, theme.name)

interface AppThemeContextType extends AppThemeType {
    changeTheme: (newThemeName: ThemeName, callback?: VoidFunction ) => void
}

export const AppThemeContext = createContext<AppThemeContextType>(null!)

export function useAppTheme(){
    return useContext(AppThemeContext)
}

export function AppThemeProvider({ children }: {children: React.ReactNode} ) {
    const [themeInfo, setTheme] = useState<AppThemeType>(getDefaultTheme())

    const changeTheme = (newThemeName: ThemeName, callback?: VoidFunction) => {
        if(newThemeName === themeInfo.name) return;

        let newThemeInfo: AppThemeType = objectToTheme(newThemeName)
        
        setTheme(newThemeInfo)
        setDefaultTheme(newThemeInfo)
        if(callback) callback();
    }

    let contextValue = {...themeInfo, changeTheme}

    return  ( 
        <AppThemeContext.Provider value={contextValue}>
            <ThemeProvider theme={themeInfo.theme}>
                {children}
            </ThemeProvider>
        </AppThemeContext.Provider>
    )
}